<!doctype html><html><head><meta charset="utf-8" /><meta content="IE=edge;chrome=1" http-equiv="X-UA-Compatible" /><title>adamwong246.github.io - Buildpacks and my first Sinatra app</title><link href="/assets/css/normalize.css" media="screen" rel="stylesheet" type="text/css" />
<link href="/assets/css/all.css" media="screen" rel="stylesheet" type="text/css" /><link href='http://fonts.googleapis.com/css?family=Raleway:400,200,700' rel='stylesheet' type='text/css'><script src="/assets/js/all.js" type="text/javascript"></script></head><body class="HolyGrail"><header><hgroup><h1>Adam Wong</h1><h2>Codesmith<i> par excellence</i></h2><h2><a href="mailto:adamwong246@gmail.com" title="email">adamwong246@gmail.com</a><a href="https://github.com/adamwong246" title="githubalt"><span class="symbol">githubalt</span></a><a href="http://stackoverflow.com/users/614612/adamwong246" title="stackoverflow"><span class="symbol">stackoverflow</span></a></h2></hgroup></header><div class="HolyGrail-body"><div class="HolyGrail-content" id="main" role="main">  <article>
    <h2><a href="/blog/2013/12/27/my-first-sinatra-app.html">Buildpacks and my first Sinatra app</a> <span>Dec 27</span></h2>
    <p>I've been working on a feature for cropping photos. We store the image with paperclip and paperclip calls imagemagick to perform the actual cropping and editing of each photo. Sadly, it seems that heroku's imagemagick is woefully out of date, causing a major discrepancy between our local and remote instances. You could use the same image and the same command but get differently cropped images, depending on whether it was executed locally or on heroku. </p><pre class="terminal">projectv git:(aw-buildpack-experiment) convert --version
Version: ImageMagick 6.8.0-10 2013-03-03 Q16 http://www.imagemagick.org
Copyright: Copyright (C) 1999-2013 ImageMagick Studio LLC
Features:  OpenCL</pre><pre class="terminal">projectv git:(aw-buildpack-experiment) heroku run convert --version --app hubbub-qa2
Running `convert --version` attached to terminal... up, run.3098
Version: ImageMagick 6.5.7-8 2012-08-17 Q16 http://www.imagemagick.org
Copyright: Copyright (C) 1999-2009 ImageMagick Studio LLC
Features: OpenMP</pre><p>Most Rails devs would at this point ask why this can't be fixed with Bundler. The answer is that Bundler only handles ruby gems. Imagemagick is a library, probably written in C. Don't confuse Imagemagick for RMagick, which is just a programmatic ruby api to the Imagemagick core library. Paperclip bypasses Ruby all together and performs the conversion on the command line.</p><p><a href="https://devcenter.heroku.com/articles/buildpacks">Enter buildpacks.</a> Buildpacks are what heroku uses to install binary executables to dynos.</p><blockquote cite="https://devcenter.heroku.com/articles/buildpacks">When you git push heroku, Herokuâ€™s slug compiler prepares your code for execution by the Heroku dyno manager. At the heart of the slug compiler is a collection of scripts called a buildpack.</blockquote><p>In our case, we needed the latest version of Imagemagick. The easiest way is documented <a href="https://github.com/mcollina/heroku-buildpack-imagemagick">here.</a> If you do it right, you should get something like this:<pre class="terminal">projectv git:(aw-buildpack-experiment) heroku run convert --version --app hubbub-qa1 
Running `convert --version` attached to terminal... up, run.6237 
Version: ImageMagick 6.8.2-3 2013-02-03 Q16 http://www.imagemagick.org
Copyright: Copyright (C) 1999-2013 ImageMagick Studio LLC
Features: DPC OpenMP
  Delegates: bzlib djvu freetype jng jp2 jpeg lcms openexr png ps tiff x xml zlib</pre></p><p>I was not prepared to start installing stuff on our repos over christmas. Who knows what sorts of gremlins are waiting in the wings? And trashing our testing environments sounded like a good way to get in big trouble. Instead, I decided to whip up a very small test case and push it to a free heroku instance. <a href="https://github.com/adamwong246/awong-buildpack-test">Here is the final result.</a> It's just a very small sinatra app, my very first. There's only 2 usefull paths: <a href="http://awong-buildpack-test.herokuapp.com/jpg">jpg,</a> which displays a test image, and <a href="http://awong-buildpack-test.herokuapp.com/png">png</a> which processes the test image with the now-up-to-date imagemagick library and returns it in a png. And the image came our just like it was supposed to! Having successfully updated imagemagick on a Guinea pig, I moved on to our qa server. Now our images were being edited just as expected. </p><style type="text/css">blockquote {
  background: #f9f9f9;
  border-left: 10px solid #ccc;
  margin: 1.5em 10px;
  padding: 0.5em 10px;
}

blockquote:before {
  color: #ccc;
  content: open-quote;
  font-size: 4em;
  line-height: 0.1em;
  margin-right: 0.25em;
  vertical-align: -0.4em;
}
blockquote p {
  display inline;
}</style>
  </article>
</div><nav class="HolyGrail-nav sidebar"><hgroup><h3><a href="/about_me.html">about me</a></h3><h4><a href="/blog/tags/posts.html">posts</a></h4><h4><a href="/blog/tags/experiments.html">experiments</a></h4><h6><a href="/blog/2014/01/10/switch-to-middleman.html">Recent post: Switch to Middleman</a></h6></hgroup></nav><aside class="HolyGrail-ads"></aside></div><footer class="footer"><ul><li>Adam Wong, 2014</li><li><a href="Copying">Released under the WTFPL</a></li><li><a href="https://github.com/adamwong246/adamwong246.github.io">source</a></li></ul><div class="signature"><object><svg viewBox="0 0 640 480" xmlns="http://www.w3.org/2000/svg"><!-- Created with SVG-edit - http://svg-edit.googlecode.com/ --><g><title>Layer 1</title><g id="svg_1"><path stroke="#FFFFFF" fill="none" stroke-width="5" stroke-dasharray="null" stroke-linejoin="null" stroke-linecap="null" id="svg_28" d="m31.497704,329.275909c1.397758,0 5.713264,-1.109741 12.579849,-4.193268c8.553589,-3.841125 20.910904,-9.939575 55.910461,-22.364166c27.911491,-9.908386 70.982491,-22.026184 123.002998,-36.341827c104.267654,-28.693573 184.504471,-50.319382 271.165665,-72.683578l82.467896,-16.773132"></path><path stroke="#FFFFFF" fill="none" stroke-width="5" stroke-dasharray="null" stroke-linejoin="null" stroke-linecap="null" id="svg_26" d="m30.099941,448.085632c0,1.397766 -2.039057,1.826233 -2.795521,0c-1.069811,-2.582703 1.232979,-11.221802 8.386566,-40.535065c4.098991,-16.796448 14.479336,-59.005249 30.750748,-106.229858c19.878845,-57.694504 42.760948,-113.476639 53.114929,-135.582855c10.605553,-22.64328 17.516258,-35.666718 25.159706,-41.932846c3.897415,-3.195099 8.407516,-5.249481 11.182083,-5.591049c5.71994,-0.70414 9.784332,-1.397758 11.182098,-1.397758c2.795517,0 4.310669,1.342094 5.591049,4.193291c3.083542,6.866592 8.020737,39.200333 13.9776,72.683578c9.219254,51.820892 21.512238,95.363663 40.53508,145.367172c8.029282,21.105835 13.977615,40.535095 18.170898,48.921661c1.397766,2.795532 2.635117,-0.066315 5.591049,-6.988831c6.632416,-15.53241 17.016357,-37.637604 32.148499,-74.081329c15.627228,-37.635986 22.672363,-64.303024 47.523895,-82.467911c6.076904,-4.441833 -5.819092,32.365311 1.397766,111.820908c2.72934,30.049835 17.116272,38.395233 30.750732,29.352997c22.254883,-14.759308 89.456757,-132.787338 190.095551,-272.563477l39.137329,-51.717167l0,-4.193287"></path></g></g></svg></object></div></footer></body></html>